/** VisionFlow: Unified Project & Task Intelligence System */

const SHEET_ID = "19sZNEU5TXx5yPLH_qyDaQusGbKIWx90K_IN7b5fm3cg";
const DASHBOARD_SHEET = "Dashboard";
const TASKS_SHEET = "Tasks";
const ARCHIVE_SHEET = "ClosedProjects";
const PROJECTS_SHEET = "Projects";
const ADMIN_EMAIL = "visionflowintel@gmail.com";

function doGet(e) {
  const page = (e && e.parameter && e.parameter.page) || "UnifiedForm";
  return HtmlService.createHtmlOutputFromFile(page).setTitle("VisionFlow");
}

function getProjectList() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(PROJECTS_SHEET);
    const values = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
    return values.filter(p => p);
  } catch (err) {
    Logger.log("Error in getProjectList: " + err.message);
    throw new Error("Failed to load project list.");
  }
}

function addTask(taskObj) {
  try {
    if (!taskObj.project || !taskObj.task || !taskObj.owner || !taskObj.dueDate) {
      throw new Error("Task section incomplete. Please fill all required task fields.");
    }
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(TASKS_SHEET);
    sheet.appendRow([
      new Date(),
      taskObj.project.trim(),
      taskObj.task.trim(),
      taskObj.owner.trim(),
      new Date(taskObj.dueDate),
      "Open",
      taskObj.priority || "Normal",
      taskObj.notes || "",
      taskObj.type || "General"
    ]);
    updateDashboard();
    syncProjectsFromTasks();
    sendTaskNotification(taskObj);
    return "✅ Task added.";
  } catch (err) {
    Logger.log("Error in addTask: " + err.message);
    throw new Error("Task submission failed: " + err.message);
  }
}

function addNewProject(project) {
  try {
    if (!project.name || !project.owner || !project.start) {
      throw new Error("Project section incomplete. Please fill all required project fields.");
    }
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(PROJECTS_SHEET);
    const cleanStart = new Date(project.start);
    const cleanEnd = project.end ? new Date(project.end) : "";
    const startDate = new Date(cleanStart.getFullYear(), cleanStart.getMonth(), cleanStart.getDate());
    const endDate = cleanEnd ? new Date(cleanEnd.getFullYear(), cleanEnd.getMonth(), cleanEnd.getDate()) : "";
    sheet.appendRow([
      project.name.trim(),
      startDate,
      endDate,
      project.owner.trim(),
      project.status || "Active",
      project.budget || "",
      project.description || "",
      new Date()
    ]);
    return "✅ Project added.";
  } catch (err) {
    Logger.log("Error in addNewProject: " + err.message);
    throw new Error("Project submission failed: " + err.message);
  }
}

function doPost(e) {
  try {
    if (e.postData && e.postData.contents && e.postData.type === "application/json") {
      const data = JSON.parse(e.postData.contents);
      if (data.project) {
        return ContentService.createTextOutput(addNewProject(data.project)).setMimeType(ContentService.MimeType.TEXT);
      }
      if (data.task) {
        return ContentService.createTextOutput(addTask(data.task)).setMimeType(ContentService.MimeType.TEXT);
      }
    }

    const pName = e.parameter["Project Name"];
    const pOwner = e.parameter["Project Owner"];
    const pStart = e.parameter["Start Date"];

    if (pName && pOwner && pStart) {
      const project = {
        name: pName,
        start: pStart,
        end: e.parameter["End Date"],
        owner: pOwner,
        status: e.parameter["Status"],
        budget: e.parameter["Budget"],
        description: e.parameter["Description"]
      };
      return ContentService.createTextOutput(addNewProject(project)).setMimeType(ContentService.MimeType.TEXT);
    }

    return ContentService.createTextOutput("❌ Error: No valid task or project payload").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("❌ Error: " + err.message).setMimeType(ContentService.MimeType.TEXT);
  }
}  
