// VisionFlow: Unified Project & Task Intelligence System
// Connected to: https://docs.google.com/spreadsheets/d/19sZNEU5TXx5yPLH_qyDaQusGbKIWx90K_IN7b5fm3cg

const SHEET_ID = "19sZNEU5TXx5yPLH_qyDaQusGbKIWx90K_IN7b5fm3cg";
const DASHBOARD_SHEET = "Dashboard";
const TASKS_SHEET = "Tasks";
const ARCHIVE_SHEET = "ClosedProjects";
const PROJECTS_SHEET = "Projects";
const ADMIN_EMAIL = "visionflowintel@gmail.com";

/** Serve Unified Form Web Interface */
function doGet(e) {
  const page = (e && e.parameter && e.parameter.page) || "UnifiedForm";
  return HtmlService.createHtmlOutputFromFile(page).setTitle("VisionFlow");
}

/** Provide project list for dropdown */
function getProjectList() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(PROJECTS_SHEET);
    const values = sheet.getRange(2, 1, sheet.getLastRow() - 1).getValues().flat();
    return values.filter(p => p);
  } catch (err) {
    Logger.log("Error in getProjectList: " + err.message);
    throw new Error("Failed to load project list.");
  }
}

/** Add new task */
function addTask(taskObj) {
  try {
    if (!taskObj.project || !taskObj.task || !taskObj.owner || !taskObj.dueDate) {
      throw new Error("Task section incomplete. Please fill all required task fields.");
    }
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(TASKS_SHEET);
    sheet.appendRow([
      new Date(),
      taskObj.project.trim(),
      taskObj.task.trim(),
      taskObj.owner.trim(),
      new Date(taskObj.dueDate),
      "Open",
      taskObj.priority || "Normal",
      taskObj.notes || "",
      taskObj.type || "General"
    ]);
    updateDashboard();
    syncProjectsFromTasks();
    sendTaskNotification(taskObj);
    return "âœ… Task added.";
  } catch (err) {
    Logger.log("Error in addTask: " + err.message);
    throw new Error("Task submission failed: " + err.message);
  }
}

/** Add new project */
function addNewProject(project) {
  try {
    if (!project.name || !project.owner || !project.start) {
      throw new Error("Project section incomplete. Please fill all required project fields.");
    }

    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(PROJECTS_SHEET);

    const cleanStart = new Date(project.start);
    const cleanEnd = project.end ? new Date(project.end) : "";

    const startDate = new Date(cleanStart.getFullYear(), cleanStart.getMonth(), cleanStart.getDate());
    const endDate = cleanEnd ? new Date(cleanEnd.getFullYear(), cleanEnd.getMonth(), cleanEnd.getDate()) : "";

    sheet.appendRow([
      project.name.trim(),
      startDate,
      endDate,
      project.owner.trim(),
      project.status || "Active",
      project.budget || "",
      project.description || "",
      new Date() // Timestamp in Column H
    ]);
    return "âœ… Project added.";
  } catch (err) {
    Logger.log("Error in addNewProject: " + err.message);
    throw new Error("Project submission failed: " + err.message);
  }
}

/** Dashboard update logic */
function updateDashboard() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(DASHBOARD_SHEET);
    const data = SpreadsheetApp.openById(SHEET_ID).getSheetByName(TASKS_SHEET).getDataRange().getValues();
    let active = 0, overdue = 0, completed = 0, today = new Date();
    for (let i = 1; i < data.length; i++) {
      const dueDate = new Date(data[i][4]);
      const status = data[i][5];
      if (status === "Completed") completed++;
      else if (dueDate < today) overdue++;
      else active++;
    }
    sheet.getRange("B2").setValue(active);
    sheet.getRange("B3").setValue(overdue);
    sheet.getRange("B4").setValue(completed);
    sheet.getRange("B6").setValue(new Date());
    drawStatusChart();
  } catch (err) {
    Logger.log("Error in updateDashboard: " + err.message);
    throw new Error("Dashboard update failed.");
  }
}

/** Draws chart for dashboard */
function drawStatusChart() {
  try {
    const dashboardSheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(DASHBOARD_SHEET);
    const data = getChartData();
    const range = dashboardSheet.getRange("D2:F" + (data.length + 1));
    range.clearContent();
    range.offset(0, 0, data.length, 3).setValues(data);
    const chart = dashboardSheet.newChart()
      .asColumnChart()
      .addRange(range.offset(0, 0, data.length, 3))
      .setPosition(1, 8, 0, 0)
      .setOption("title", "Project Task Status")
      .setOption("isStacked", true)
      .setOption("legend", { position: "bottom" })
      .setOption("colors", ["#f39c12", "#2ecc71"])
      .build();
    dashboardSheet.getCharts().forEach(c => dashboardSheet.removeChart(c));
    dashboardSheet.insertChart(chart);
  } catch (err) {
    Logger.log("Error in drawStatusChart: " + err.message);
    throw new Error("Chart generation failed.");
  }
}

function getChartData() {
  try {
    const data = SpreadsheetApp.openById(SHEET_ID).getSheetByName(TASKS_SHEET).getDataRange().getValues();
    const map = {};
    for (let i = 1; i < data.length; i++) {
      const p = data[i][1], s = data[i][5];
      if (!map[p]) map[p] = { Open: 0, Completed: 0 };
      map[p][s] = (map[p][s] || 0) + 1;
    }
    return [["Project", "Open", "Completed"]].concat(Object.entries(map).map(([p, s]) => [p, s.Open || 0, s.Completed || 0]));
  } catch (err) {
    Logger.log("Error in getChartData: " + err.message);
    throw new Error("Chart data generation failed.");
  }
}

/** Auto-sync projects from tasks */
function syncProjectsFromTasks() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID);
    const tasks = sheet.getSheetByName(TASKS_SHEET).getDataRange().getValues();
    const projectSheet = sheet.getSheetByName(PROJECTS_SHEET);
    const existing = projectSheet.getRange(2, 1, projectSheet.getLastRow() - 1).getValues().flat();
    const unique = [...new Set(tasks.slice(1).map(r => r[1]).filter(p => p))];
    const rows = unique.filter(p => !existing.includes(p)).map(p => {
      const match = tasks.find(r => r[1] === p);
      return [p, match[0], "", match[3], "Active", "", match[7] || ""];
    });
    if (rows.length) projectSheet.getRange(projectSheet.getLastRow() + 1, 1, rows.length, 7).setValues(rows);
  } catch (err) {
    Logger.log("Error in syncProjectsFromTasks: " + err.message);
    throw new Error("Project sync failed.");
  }
}

/** Notify owner via email */
function sendTaskNotification(taskObj) {
  try {
    MailApp.sendEmail({
      to: taskObj.owner,
      subject: `ðŸ“Œ New Task: ${taskObj.task}`,
      body: `Hello ${taskObj.owner},\n\nYou've received a task under *${taskObj.project}*:\nðŸ“‹ ${taskObj.task}\nðŸ—“ Due: ${taskObj.dueDate}\nðŸŒŸ Priority: ${taskObj.priority}\nðŸ“œ Notes: ${taskObj.notes}\n\n-- VisionFlow`
    });
  } catch (err) {
    Logger.log("Error in sendTaskNotification: " + err.message);
  }
}

/** Public API */
function getVisionFlowData() {
  try {
    const data = SpreadsheetApp.openById(SHEET_ID).getSheetByName(TASKS_SHEET).getDataRange().getValues();
    const headers = data[0];
    const tasks = data.slice(1).map(row => Object.fromEntries(headers.map((h, i) => [h, row[i]])));
    return ContentService.createTextOutput(JSON.stringify(tasks)).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log("Error in getVisionFlowData: " + err.message);
    throw new Error("Failed to serve data.");
  }
}

/** Gantt Timeline Data Provider */
function getGanttData() {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(PROJECTS_SHEET);
  const data = sheet.getDataRange().getValues();
  const result = [["Project", "Task", "Start", "End"]];

  for (let i = 1; i < data.length; i++) {
    const name = data[i][0];
    let start = data[i][1];
    let end = data[i][2];

    if (start instanceof Date && end instanceof Date) {
      start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      end = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      result.push([name, name, start, end]);
    }
  }

  return result;
}

/** Updated doPost handler for both FormData and JSON */
function doPost(e) {
  try {
    let project = null;

    if (e.postData && e.postData.contents && e.postData.type === "application/json") {
      const data = JSON.parse(e.postData.contents);
      if (data.project) {
        project = data.project;
      }
    } else if (e.parameter["Project Name"]) {
      project = {
        name: e.parameter["Project Name"],
        start: e.parameter["Start Date"],
        end: e.parameter["End Date"],
        owner: e.parameter["Project Owner"],
        status: e.parameter["Status"],
        budget: e.parameter["Budget"],
        description: e.parameter["Description"]
      };
    }

    if (project) {
      const result = addNewProject(project);
      return ContentService.createTextOutput(result).setMimeType(ContentService.MimeType.TEXT);
    } else {
      return ContentService.createTextOutput("âŒ Error: No valid project payload").setMimeType(ContentService.MimeType.TEXT);
    }

  } catch (err) {
    return ContentService.createTextOutput("âŒ Error: " + err.message).setMimeType(ContentService.MimeType.TEXT);
  }
}


